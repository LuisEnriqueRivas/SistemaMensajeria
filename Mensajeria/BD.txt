CREATE DATABASE chat_secure_db;

USE chat_secure_db;

//Se almacenan las credenciales. La contraseña se guarda cifrada (AES-GCM)
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    password_iv VARCHAR(255) NOT NULL
);

CREATE TABLE conversations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    password_iv VARCHAR(255) NOT NULL
);

CREATE TABLE messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    conversation_id INT NOT NULL,
    user_id INT NOT NULL,
    encrypted_content TEXT NOT NULL,
    iv VARCHAR(255) NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_messages_conversation
        FOREIGN KEY (conversation_id) REFERENCES conversations(id)
        ON DELETE CASCADE,
        
    CONSTRAINT fk_messages_user
        FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE
);


//Creación del usuario de servicio que utilizará la aplicación Java.
CREATE USER 'administrador'@'%' IDENTIFIED BY 'administrador';
GRANT ALL PRIVILEGES ON chat_secure_db.* TO 'administrador'@'%';

-- Acceso Local (Servidor)
CREATE USER 'administrador'@'localhost' IDENTIFIED BY 'administrador';
GRANT ALL PRIVILEGES ON chat_secure_db.* TO 'administrador'@'localhost';

-- Aplicación de privilegios
FLUSH PRIVILEGES;